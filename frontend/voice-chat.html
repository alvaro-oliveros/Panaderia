<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat por Voz - PanaderÃ­a</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/voice-chat.css">
    <script>
        // Immediate auth check to prevent flash of content
        (function() {
            const userData = sessionStorage.getItem('userData');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }
            // If we get here, user is authenticated, show the page
            document.documentElement.style.visibility = 'visible';
        })();
    </script>
    <style>
        /* Hide content by default until auth check completes */
        html { visibility: hidden; }
    </style>
</head>
<body>
    <header class="dashboard-header">
        <h1>ğŸ¤ Chat por Voz - Asistente de PanaderÃ­a</h1>
        <div class="user-info">
            <span id="userWelcome"></span>
            <a href="index.html" class="back-btn">â† Dashboard</a>
            <button onclick="logout()" class="logout-btn">Cerrar SesiÃ³n</button>
        </div>
    </header>
    
    <main class="voice-chat-container">
        <!-- Chat Messages Area -->
        <div class="chat-area" id="chatArea">
            <div class="welcome-message">
                <div class="bot-message">
                    <div class="message-content">
                        <h3>Â¡Hola! Soy tu asistente de panaderÃ­a</h3>
                        <p>Puedes preguntarme sobre:</p>
                        <ul>
                            <li>ğŸ“Š Ventas e ingresos ("Â¿CuÃ¡nto vendimos esta semana?")</li>
                            <li>ğŸ“¦ Stock e inventario ("Â¿QuÃ© productos tienen poco stock?")</li>
                            <li>ğŸŒ¡ï¸ Condiciones ambientales ("Â¿CÃ³mo estÃ¡ la temperatura?")</li>
                            <li>ğŸª Rendimiento por sede ("Â¿CuÃ¡l sede vende mÃ¡s?")</li>
                            <li>ğŸ¥– Productos mÃ¡s vendidos ("Â¿CuÃ¡les son los productos top?")</li>
                        </ul>
                        <p><strong>Presiona el botÃ³n del micrÃ³fono y habla en espaÃ±ol</strong></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Voice Controls -->
        <div class="voice-controls">
            <!-- Recording Indicator -->
            <div class="recording-indicator" id="recordingIndicator" style="display: none;">
                <div class="pulse-animation"></div>
                <span>Escuchando...</span>
            </div>
            
            <!-- Audio Visualizer -->
            <div class="audio-visualizer" id="audioVisualizer" style="display: none;">
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
            </div>
            
            <!-- Main Voice Button -->
            <button id="voiceButton" class="voice-button" onclick="toggleRecording()">
                <span class="mic-icon">ğŸ¤</span>
                <span class="button-text">Hablar</span>
            </button>
            
            <!-- Status Display -->
            <div class="status-display" id="statusDisplay">
                <span id="statusText">Presiona para hablar</span>
                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>
        
        <!-- Quick Action Buttons -->
        <div class="quick-actions">
            <button class="quick-btn" onclick="quickQuery('Â¿QuÃ© productos tienen stock bajo?')">
                ğŸ“¦ Stock bajo
            </button>
            <button class="quick-btn" onclick="quickQuery('Â¿CuÃ¡les fueron las ventas de esta semana?')">
                ğŸ’° Ventas semanales
            </button>
            <button class="quick-btn" onclick="quickQuery('Â¿CÃ³mo estÃ¡n las condiciones ambientales?')">
                ğŸŒ¡ï¸ Temperatura
            </button>
            <button class="quick-btn" onclick="quickQuery('Â¿CuÃ¡les son los productos mÃ¡s vendidos?')">
                ğŸ† Top productos
            </button>
        </div>
        
        <!-- Session Info -->
        <div class="session-info">
            <span id="sessionInfo">Nueva sesiÃ³n</span>
            <button id="clearChatBtn" onclick="clearChat()" style="display: none;">ğŸ—‘ï¸ Limpiar</button>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="loading-spinner"></div>
            <p id="loadingText">Procesando audio...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/api.js"></script>
    <script src="js/voice-chat.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userData = checkAuth();
            if (!userData) {
                return;
            }
            
            setupUserInterface(userData);
            initializeVoiceChat();
        });

        function setupUserInterface(userData) {
            const userWelcome = document.getElementById('userWelcome');
            userWelcome.textContent = `Bienvenido, ${userData.username}`;
        }
    </script>
</body>
</html>